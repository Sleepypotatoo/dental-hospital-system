<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>åŒ»é™¢ç®¡ç†ç³»ç»Ÿç™»å½•é¡µé¢</title>
    <link rel="stylesheet" href="css/login.css">
    <style>
        /* è¿™é‡Œå¯ä»¥æ·»åŠ ä¸€äº›é¢å¤–çš„å†…è”æ ·å¼ */
        /* å®šä¹‰å°çœ¼ç›å›¾æ ‡æ ·å¼ */
        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            z-index: 10;
            color: #999;
            transition: color 0.3s;
        }
        
        .password-toggle:hover {
            color: #003366;
        }
        
        .input-group {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .input-group input {
            padding-right: 30px; /* ä¸ºå›¾æ ‡ç•™å‡ºç©ºé—´ */
        }
    </style>
</head>

<body style="background: url('image/background.jpg'); background-size: cover; background-repeat: no-repeat;">
    <script src="js/flexible.js"></script>
    <!-- æ–°å¢é®ç½©å±‚ -->
    <div id="overlay"></div>
    <div class="login-container">
        <div class="login">
            <h2>åŒ»é™¢ç®¡ç†ç³»ç»Ÿ</h2>
            <form id="loginForm">
                <div class="input-group">
                    <label for="username">è´¦å·</label>
                    <input type="text" id="username" placeholder="è¯·è¾“å…¥è´¦å·" required>
                </div>
                <div class="input-group">
                    <label for="password">å¯†ç </label>
                    <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç " required>
                    <i class="password-toggle" id="toggleLoginPassword" data-visible="false">ğŸ‘ï¸</i>
                </div>
                <div class="input-group">
                    <label for="userType">èº«ä»½</label>
                    <select id="userType">
                        <option value="patient">æ‚£è€…</option>
                        <option value="doctor">åŒ»ç”Ÿ</option>
                        <option value="admin">ç®¡ç†å‘˜</option>
                    </select>
                </div>
                <button type="submit">ç™»å½•</button>
                <button type="button" id="registerBtn">æ³¨å†Œ</button>
            </form>
        </div>
    </div>

    <!-- æ–°å¢ç™»å½•é”™è¯¯å¼¹çª— -->
    <div id="errorModal" class="modal">
        <div class="modal-content">
            <p>è´¦å·æˆ–å¯†ç é”™è¯¯ï¼</p>
            <!-- æ·»åŠ ç¡®è®¤æŒ‰é’® -->
            <button id="confirmBtn">ç¡®è®¤</button>
        </div>
    </div>

    <!-- æ–°å¢æ³¨å†Œå¼¹çª— -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <h2>æ‚£è€…æ³¨å†Œ</h2>
            <form id="registerForm">
                <div class="input-group">
                    <label for="regUsername">è´¦å·</label>
                    <input type="text" id="regUsername" placeholder="è¯·è¾“å…¥è´¦å·" required>
                </div>
                <div class="input-group">
                    <label for="regPassword">å¯†ç </label>
                    <input type="password" id="regPassword" placeholder="è¯·è¾“å…¥å¯†ç " required>
                    <i class="password-toggle" id="toggleRegisterPassword" data-visible="false">ğŸ‘ï¸</i>
                </div>
                <div class="input-group">
                    <label for="regName">å§“å</label>
                    <input type="text" id="regName" placeholder="è¯·è¾“å…¥å§“å" required>
                </div>
                <div class="input-group">
                    <label for="regGender">æ€§åˆ«</label>
                    <input type="text" id="regGender" placeholder="è¯·è¾“å…¥æ€§åˆ«">
                </div>
                <div class="input-group">
                    <label for="regBirthdate">å‡ºç”Ÿæ—¥æœŸ</label>
                    <input type="date" id="regBirthdate" required>
                </div>
                <div class="input-group">
                    <label for="regPhone">æ‰‹æœºå·</label>
                    <input type="text" id="regPhone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·">
                </div>
                <div class="input-group">
                    <label for="regEmail">é‚®ç®±</label>
                    <input type="email" id="regEmail" placeholder="è¯·è¾“å…¥é‚®ç®±" required>
                </div>
                <div class="input-group">
                    <label for="regIDCard">èº«ä»½è¯å·</label>
                    <input type="text" id="regIDCard" placeholder="è¯·è¾“å…¥èº«ä»½è¯å·">
                </div>
                <button type="submit">æäº¤</button>
                <button type="button" id="closeRegisterModalBtn">å…³é—­</button>
            </form>
        </div>
    </div>

    <script>
        // å¯æ ¹æ®ç¯å¢ƒä¿®æ”¹ API åŸºç¡€åœ°å€
        const API_BASE_URL = 'http://localhost:8080';

        // è·å–è¡¨å•å’Œå¼¹çª—å…ƒç´ 
        const loginForm = document.getElementById('loginForm');
        const errorModal = document.getElementById('errorModal');
        const registerModal = document.getElementById('registerModal');
        // è·å–ç¡®è®¤æŒ‰é’®
        const confirmBtn = document.getElementById('confirmBtn');
        // è·å–æ³¨å†ŒæŒ‰é’®
        const registerBtn = document.getElementById('registerBtn');
        // è·å–å…³é—­æ³¨å†Œå¼¹çª—æŒ‰é’®
        const closeRegisterModalBtn = document.getElementById('closeRegisterModalBtn');
        // è·å–æ³¨å†Œè¡¨å•
        const registerForm = document.getElementById('registerForm');
        // è·å– body å…ƒç´ 
        const body = document.body;
        // è·å–é®ç½©å±‚å…ƒç´ 
        const overlay = document.getElementById('overlay');
        // è·å–å¯†ç è¾“å…¥æ¡†å’Œåˆ‡æ¢å›¾æ ‡
        const loginPasswordInput = document.getElementById('password');
        const toggleLoginPassword = document.getElementById('toggleLoginPassword');
        const registerPasswordInput = document.getElementById('regPassword');
        const toggleRegisterPassword = document.getElementById('toggleRegisterPassword');

        // é¡µé¢åŠ è½½å®Œæˆæ—¶ï¼Œç¡®ä¿æ‰€æœ‰å¼¹çª—å’Œé®ç½©å±‚éƒ½éšè—
        window.onload = function () {
            errorModal.style.display = 'none';
            registerModal.style.display = 'none';
            overlay.style.display = 'none';
            body.classList.remove('no-scroll');
            
            // ç¡®ä¿åˆå§‹çŠ¶æ€ä¸ºå¯†ç ä¸å¯è§
            updateEyeIcon(toggleLoginPassword, false);
            updateEyeIcon(toggleRegisterPassword, false);
        };

        // ç›‘å¬è¡¨å•æäº¤äº‹ä»¶
        loginForm.addEventListener('submit', function (e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const userType = document.getElementById('userType').value;

            const data = {
                username: username,
                password: password
            };

            // å‘é€ç™»å½•è¯·æ±‚åˆ°åç«¯API
            fetch(`${API_BASE_URL}/api/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
                }
                return response.text();
            })
            .then(data => {
                if (data === 'success') {
                    // ç™»å½•æˆåŠŸï¼Œæ ¹æ®ç”¨æˆ·ç±»å‹è·³è½¬åˆ°ä¸åŒé¡µé¢
                    if (userType === 'doctor') {
                        window.location.href = 'doctor.html';
                    } else if (userType === 'patient') {
                        window.location.href = 'patient.html';
                    } else if (userType === 'admin') {
                        window.location.href = 'admin.html';
                    }
                } else {
                    // ç™»å½•å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯å¼¹çª—å’Œé®ç½©å±‚
                    errorModal.style.display = 'block';
                    overlay.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('ç™»å½•è¯·æ±‚å‡ºé”™:', error);
                alert('ç™»å½•è¯·æ±‚å‡ºé”™ï¼Œè¯·ç¨åå†è¯•');
            });
        });

        // ç›‘å¬ç¡®è®¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        confirmBtn.addEventListener('click', function () {
            errorModal.style.display = 'none';
            overlay.style.display = 'none';
        });

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­å¼¹çª—å’Œé®ç½©å±‚
        window.addEventListener('click', function (event) {
            if (event.target === errorModal) {
                errorModal.style.display = 'none';
                overlay.style.display = 'none';
            }
            if (event.target === registerModal) {
                registerModal.style.display = 'none';
                overlay.style.display = 'none';
                body.classList.remove('no-scroll'); // ç§»é™¤éšè—æ»šåŠ¨æ¡çš„ç±»
            }
        });

        // ç›‘å¬æ³¨å†ŒæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        registerBtn.addEventListener('click', function () {
            const userType = document.getElementById('userType').value;
            if (userType === 'patient') {
                registerModal.style.display = 'block';
                overlay.style.display = 'block';
                body.classList.add('no-scroll'); // æ·»åŠ éšè—æ»šåŠ¨æ¡çš„ç±»
            } else {
                alert('åªæœ‰æ‚£è€…å¯ä»¥æ³¨å†Œ');
            }
        });

        // ç›‘å¬å…³é—­æ³¨å†Œå¼¹çª—æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        closeRegisterModalBtn.addEventListener('click', function () {
            registerModal.style.display = 'none';
            overlay.style.display = 'none';
            body.classList.remove('no-scroll'); // ç§»é™¤éšè—æ»šåŠ¨æ¡çš„ç±»
        });

        // ç›‘å¬æ³¨å†Œè¡¨å•æäº¤äº‹ä»¶
        registerForm.addEventListener('submit', function (e) {
            e.preventDefault();
            
            // æ”¶é›†æ³¨å†Œè¡¨å•æ•°æ®
            const data = {
                username: document.getElementById('regUsername').value,
                password: document.getElementById('regPassword').value,
                name: document.getElementById('regName').value,
                gender: document.getElementById('regGender').value,
                birthdate: document.getElementById('regBirthdate').value,
                phone: document.getElementById('regPhone').value,
                email: document.getElementById('regEmail').value,
                idCard: document.getElementById('regIDCard').value
            };

            // å‘é€æ³¨å†Œè¯·æ±‚åˆ°åç«¯API
            fetch(`${API_BASE_URL}/api/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
                }
                return response.text();
            })
            .then(data => {
                if (data === 'success') {
                    alert('æ³¨å†ŒæˆåŠŸ');
                    registerModal.style.display = 'none';
                    overlay.style.display = 'none';
                    body.classList.remove('no-scroll'); // ç§»é™¤éšè—æ»šåŠ¨æ¡çš„ç±»
                } else {
                    alert('æ³¨å†Œå¤±è´¥');
                }
            })
            .catch(error => {
                console.error('æ³¨å†Œè¯·æ±‚å‡ºé”™:', error);
                alert('æ³¨å†Œè¯·æ±‚å‡ºé”™ï¼Œè¯·ç¨åå†è¯•');
            });
        });

        // åˆ‡æ¢å¯†ç å¯è§æ€§
        toggleLoginPassword.addEventListener('click', function () {
            togglePasswordVisibility(loginPasswordInput, toggleLoginPassword);
        });

        toggleRegisterPassword.addEventListener('click', function () {
            togglePasswordVisibility(registerPasswordInput, toggleRegisterPassword);
        });

        // å¯†ç å¯è§æ€§åˆ‡æ¢å‡½æ•°
        function togglePasswordVisibility(input, icon) {
            const isVisible = icon.getAttribute('data-visible') === 'true';
            input.type = isVisible ? 'password' : 'text';
            icon.setAttribute('data-visible', !isVisible);
            updateEyeIcon(icon, !isVisible);
        }

        // æ›´æ–°çœ¼ç›å›¾æ ‡
        function updateEyeIcon(icon, isVisible) {
            icon.textContent = isVisible ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸';
        }
    </script>
</body>

</html>